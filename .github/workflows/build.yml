name: x86/x64 MSIX Bundle

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  actions: write

env:
  Project_Name: 'AscendiaApp'

jobs:
  build:
    runs-on: windows-latest
    outputs:
      bundle_path: ${{ steps.find-bundle.outputs.BUNDLE_PATH }}
    env:
      DOTNET_VERSION: '9.0.x'
      Configuration: 'Release'
      Solution_Name: 'Ascendia.slnx'
      Appx_Package_Dir: '${{ github.workspace }}'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0

      - name: Update manifest version
        shell: pwsh
        run: |
          [xml]$manifest = Get-Content ".\${{ env.Project_Name }}\Package.appxmanifest"
          $manifest.Package.Identity.Version = "${{ steps.gitversion.outputs.MajorMinorPatch }}.0"
          $manifest.Save(".\${{ env.Project_Name }}\Package.appxmanifest")

      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Restore
        shell: pwsh
        run: |
          msbuild ${{ env.Solution_Name }} `
            /t:Restore `
            /p:Configuration=${{ env.Configuration }}

      - name: Create appsettings.json from secrets
        shell: pwsh
        run: |
          $configDir = "AscendiaApp\Assets\Config"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          $required = @{
            AIRBASE_TOKEN='${{ secrets.AIRBASE_TOKEN }}'
            AIRBASE_BASEID='${{ secrets.AIRBASE_BASEID }}'
            DISCORD_TOKEN='${{ secrets.DISCORD_TOKEN }}'
            DISCORD_CLIENT_SECRET='${{ secrets.DISCORD_CLIENT_SECRET }}'
            TELEMETRY_KEY='${{ secrets.TELEMETRY_KEY }}'
          }
          $missing = @()
            foreach($k in $required.Keys){
              if([string]::IsNullOrWhiteSpace($required[$k])){ $missing += $k }
            }
          if($missing.Count -gt 0){ throw "Missing required secrets: $($missing -join ', ')" }
          $json = @{
            AirBaseSettings = @{
              token = "${{ secrets.AIRBASE_TOKEN }}"
              baseId = "${{ secrets.AIRBASE_BASEID }}"
            }
            DiscordSettings = @{
              token = "${{ secrets.DISCORD_TOKEN }}"
              clientSecret = "${{ secrets.DISCORD_CLIENT_SECRET }}"
            }
            TelemetryKey = @{
              key = "${{ secrets.TELEMETRY_KEY }}"
            }
          } | ConvertTo-Json -Depth 5
          Set-Content -Path (Join-Path $configDir 'appsettings.json') -Value $json -Encoding UTF8

      - name: Build MSIX Bundle (x86 + x64)
        shell: pwsh
        run: |
          msbuild ${{ env.Solution_Name }} `
            /p:Configuration=${{ env.Configuration }} `
            /p:AppxBundle=Always `
            /p:AppxBundlePlatforms="x86|x64" `
            /p:UapAppxPackageBuildMode=StoreUpload `
            /p:GenerateAppxPackageOnBuild=true `
            /p:AppxPackageDir="${{ env.Appx_Package_Dir }}\" `
            /p:AppxPackageSigningEnabled=false

      - name: Locate bundle
        id: find-bundle
        shell: pwsh
        run: |
          $version = "${{ steps.gitversion.outputs.MajorMinorPatch }}.0"
          $expected = "${{ env.Project_Name }}_${version}_x86_x64.msixbundle"
          $bundle = Get-ChildItem -Path "${{ env.Appx_Package_Dir }}" -Filter $expected -Recurse | Select-Object -First 1
          if(-not $bundle){
            Write-Host "Bundle not found by expected name, perform loose search..."
            $bundle = Get-ChildItem -Path "${{ env.Appx_Package_Dir }}" -Filter *.msixbundle -Recurse | Where-Object { $_.Name -like "*_${version}_x86_x64.msixbundle" } | Select-Object -First 1
          }
          if(-not $bundle){ throw "Could not find .msixbundle for version $version" }
          "BUNDLE_PATH=$($bundle.FullName)" >> $env:GITHUB_OUTPUT
          Write-Host "Found bundle: $($bundle.FullName)"

      - name: Upload MSIX Bundle
        uses: actions/upload-artifact@v4
        with:
          name: MsixBundle
          path: ${{ steps.find-bundle.outputs.BUNDLE_PATH }}